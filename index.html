<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - 3ª Promotoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
       window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAzad4DmO5ZyKBgMSpjsivd6c0_VJ6LwvY",
            authDomain: "painel-promotoria.firebaseapp.com",
            projectId: "painel-promotoria",
            storageBucket: "painel-promotoria.firebasestorage.app",
            messagingSenderId: "357692683201",
            appId: "1:357692683201:web:09021bd141cc33e2aeb540",
            measurementId: "G-36RC8TJSRC"
        });

        window.__app_id = 'promotoria-gestao-v1'; 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .kanban-column { min-width: 350px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#f8fafc]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, getDocs, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

        const { useState, useEffect, useRef } = React;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'promotoria-gestao-default';

        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erro Firebase:", error);
        }

        const AREAS = [
            { id: 'meio-ambiente', label: 'Meio Ambiente', icon: 'ShieldCheck' },
            { id: 'execucao-penal', label: 'Execução Penal', icon: 'Gavel' },
            { id: 'urbanismo', label: 'Urbanismo', icon: 'MapPin' },
            { id: 'delegacao', label: 'Delegação', icon: 'UserCheck' },
        ];

        const STATUS_OPTIONS = [
            'Cota de diligência', 
            'Manifestação', 
            'Aguardando Correção',
            'Encaminhado para fazer denúncia',
            'Denunciado', 
            'Encaminhado para fazer arquivamento', 
            'Arquivado',
            'Encaminhado para ANPP', 
            'Oferecido ANPP', 
            'Finalizado'
        ];

        const RENEWAL_DAYS = 90;

        const Icon = ({ name, className }) => {
            useEffect(() => { if(window.lucide) lucide.createIcons(); }, [name]);
            return <i data-lucide={name.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2')} className={className}></i>;
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message.includes('auth/invalid-credential') ? 'Dados incorretos.' : err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-md w-full border border-slate-200">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <Icon name="Lock" className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-black text-slate-800 uppercase tracking-tighter">Acesso Restrito</h1>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mt-2">Painel de Gestão</p>
                        </div>
                        <form onSubmit={handleAuth} className="flex flex-col gap-4">
                            <input type="email" placeholder="E-mail Institucional" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm font-bold" required />
                            <input type="password" placeholder="Senha" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm font-bold" required />
                            {error && <div className="text-red-500 text-xs font-bold bg-red-50 p-3 rounded-xl text-center">{error}</div>}
                            <button type="submit" className="bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg mt-2">
                                {isRegistering ? 'Cadastrar Acesso' : 'Entrar no Sistema'}
                            </button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="w-full text-center mt-6 text-xs font-bold text-slate-400 hover:text-indigo-600 uppercase tracking-wider">
                            {isRegistering ? 'Voltar para Login' : 'Primeiro acesso? Clique aqui'}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAuthorized, setIsAuthorized] = useState(false);
            const [inqueritos, setInqueritos] = useState([]);
            const [authorizedUsers, setAuthorizedUsers] = useState([]); 
            
            const [activeArea, setActiveArea] = useState('meio-ambiente');
            const [searchTerm, setSearchTerm] = useState('');
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);
            const [isTeamModalOpen, setIsTeamModalOpen] = useState(false);
            
            const [editingInquerito, setEditingInquerito] = useState(null);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                if (!auth) return;
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        const usersRef = collection(db, 'artifacts', appId, 'config', 'users', 'list');
                        
                        const unsubscribe = onSnapshot(usersRef, async (snapshot) => {
                            const allowedList = snapshot.docs.map(d => d.data().email);
                            setAuthorizedUsers(allowedList);
                            
                            if (allowedList.length === 0) {
                                await addDoc(usersRef, { email: u.email, role: 'admin', addedAt: new Date().toISOString() });
                                setIsAuthorized(true);
                                notify("Primeiro usuário configurado como Admin!");
                            } else {
                                if (allowedList.includes(u.email)) {
                                    setIsAuthorized(true);
                                } else {
                                    setIsAuthorized(false);
                                    notify("Acesso não autorizado. Contate o administrador.");
                                    setTimeout(() => signOut(auth), 3000);
                                }
                            }
                            setLoading(false);
                        });
                        return () => unsubscribe();
                    } else {
                        setUser(null);
                        setIsAuthorized(false);
                        setLoading(false);
                    }
                });
            }, []);

            useEffect(() => {
                if (!user || !isAuthorized) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos');
                return onSnapshot(q, (s) => setInqueritos(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user, isAuthorized]);

            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };

            const handleSave = async (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                const dManual = f.get('date');
                const date = dManual ? new Date(dManual + "T12:00:00Z").toISOString() : new Date().toISOString();
                
                const data = {
                    numero: f.get('numero'),
                    area: f.get('area'),
                    status: f.get('status'),
                    observacoes: f.get('obs'),
                    responsavel: f.get('responsavel'),
                    lastRenewal: date,
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                };

                try {
                    if (editingInquerito) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inqueritos', editingInquerito.id), data);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos'), data);
                    }
                    setIsModalOpen(false); setEditingInquerito(null); notify("Registro guardado!");
                } catch (err) { notify("Erro ao salvar: " + err.message); }
            };

            const handleFileUpload = async (e) => {
                e.preventDefault();
                const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n');
                    const batch = writeBatch(db);
                    let count = 0;

                    rows.forEach(row => {
                        const cols = row.split(';');
                        if (cols.length >= 2) {
                            const numero = cols[0].trim();
                            const status = cols[1].trim();
                            const obs = cols[2] ? cols[2].trim() : '';
                            
                            if(numero && STATUS_OPTIONS.includes(status)) {
                                const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos'));
                                batch.set(ref, {
                                    numero,
                                    area: 'meio-ambiente', 
                                    status,
                                    observacoes: obs,
                                    responsavel: '',
                                    lastRenewal: new Date().toISOString(),
                                    updatedAt: new Date().toISOString(),
                                    updatedBy: user.email
                                });
                                count++;
                            }
                        }
                    });

                    if (count > 0) {
                        await batch.commit();
                        notify(`${count} processos importados!`);
                        setIsUploadModalOpen(false);
                    } else {
                        notify("Nenhum dado válido encontrado. Verifique se usou ponto e vírgula.");
                    }
                };
                reader.readAsText(file);
            };

            const handleAddUser = async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                if(email) {
                    await addDoc(collection(db, 'artifacts', appId, 'config', 'users', 'list'), { email, role: 'user', addedAt: new Date().toISOString() });
                    e.target.reset();
                    notify("Usuário autorizado!");
                }
            };
            
            const handleRemoveUser = async (emailToDelete) => {
                if(confirm('Remover acesso deste usuário?')) {
                     try {
                        const q = query(collection(db, 'artifacts', appId, 'config', 'users', 'list'), where("email", "==", emailToDelete));
                        const querySnapshot = await getDocs(q);
                        querySnapshot.forEach((d) => {
                            deleteDoc(d.ref);
                        });
                        notify("Usuário removido.");
                     } catch(err) {
                        notify("Erro ao remover: " + err.message);
                     }
                }
            };

            const getDays = (date) => {
                const diff = Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24));
                return Math.max(0, RENEWAL_DAYS - diff);
            };

            const filtered = inqueritos.filter(i => {
                const matchesSearch = (i.numero.includes(searchTerm) || (i.observacoes || "").toLowerCase().includes(searchTerm.toLowerCase()) || (i.responsavel || "").toLowerCase().includes(searchTerm.toLowerCase()));
                if (activeArea === 'delegacao') {
                    return i.responsavel && i.responsavel.trim() !== '' && matchesSearch;
                }
                return i.area === activeArea && matchesSearch;
            });

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-indigo-600 animate-pulse text-xl tracking-[0.3em]">CARREGANDO...</div>;

            if (!user) return <LoginScreen />;
            if (!isAuthorized) return <div className="h-screen flex items-center justify-center text-slate-500">Verificando permissão...</div>;

            return (
                <div className="min-h-screen pb-32">
                    <header className="bg-white border-b px-8 h-20 flex items-center justify-between sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-4">
                            <div className="bg-indigo-600 p-2.5 rounded-2xl shadow-lg"><Icon name="ShieldCheck" className="text-white w-7 h-7" /></div>
                            <div>
                                <h1 className="text-xl font-black uppercase tracking-tighter text-slate-900 leading-none">Gestão Digital</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">3ª Promotoria de Justiça</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4 flex-1 max-w-5xl mx-12">
                            <div className="relative w-full group">
                                <Icon name="Search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4 group-focus-within:text-indigo-500 transition-all" />
                                <input onChange={e => setSearchTerm(e.target.value)} placeholder="Pesquisar..." className="w-full pl-12 pr-6 py-3 bg-slate-100 border-none rounded-2xl outline-none focus:ring-4 focus:ring-indigo-50 focus:bg-white transition-all text-sm shadow-inner" />
                            </div>
                            
                            <button onClick={() => setIsTeamModalOpen(true)} className="bg-slate-100 text-slate-600 font-bold px-4 py-3 rounded-2xl hover:bg-slate-200 transition-all text-xs flex items-center gap-2 whitespace-nowrap">
                                <Icon name="Users" className="w-4 h-4" /> EQUIPE
                            </button>

                            <button onClick={() => setIsUploadModalOpen(true)} className="bg-emerald-50 text-emerald-700 font-bold px-6 py-3 rounded-2xl border border-emerald-100 hover:bg-emerald-600 hover:text-white transition-all text-xs shadow-sm whitespace-nowrap flex items-center gap-2">
                                <Icon name="UploadCloud" className="w-4 h-4" /> IMPORTAR CSV
                            </button>
                            
                            <button onClick={() => { setEditingInquerito(null); setIsModalOpen(true); }} className="bg-slate-900 text-white font-bold px-8 py-3 rounded-2xl hover:bg-indigo-600 transition-all shadow-xl text-xs active:scale-95 whitespace-nowrap">NOVO REGISTRO</button>
                            
                            <button onClick={() => signOut(auth)} className="text-slate-300 hover:text-red-500 transition-all p-2"><Icon name="LogOut" className="w-5 h-5" /></button>
                        </div>
                    </header>

                    <nav className="bg-white border-b sticky top-20 z-20 flex px-8 gap-4 overflow-x-auto scrollbar-hide">
                        {AREAS.map(a => (
                            <button key={a.id} onClick={() => setActiveArea(a.id)} className={`py-6 px-10 border-b-4 transition-all flex items-center gap-3 whitespace-nowrap ${activeArea === a.id ? 'border-indigo-600 text-indigo-600 font-black' : 'border-transparent text-slate-400 font-bold hover:text-slate-600'}`}>
                                <Icon name={a.icon} className="w-5 h-5" /> {a.label.toUpperCase()}
                                <span className={`text-[10px] px-2.5 py-1 rounded-xl font-black ${activeArea === a.id ? 'bg-indigo-100' : 'bg-slate-100 text-slate-400'}`}>
                                    {activeArea === 'delegacao' && a.id === 'delegacao' ? inqueritos.filter(i => i.responsavel && i.responsavel.trim() !== '').length : inqueritos.filter(i => i.area === a.id).length}
                                </span>
                            </button>
                        ))}
                    </nav>

                    <main className="p-8 flex gap-8 overflow-x-auto min-h-[calc(100vh-160px)] scrollbar-hide">
                        {STATUS_OPTIONS.map(s => (
                            <div key={s} className="kanban-column flex flex-col gap-5">
                                <h3 className="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] px-4 flex justify-between items-center">
                                    <span className="flex items-center gap-2">
                                        <div className={`w-2.5 h-2.5 rounded-full ${s === 'Aguardando Correção' ? 'bg-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.5)]' : filtered.filter(i => i.status === s).length > 0 ? 'bg-indigo-500 shadow-lg' : 'bg-slate-300'}`}></div> 
                                        {s}
                                    </span>
                                    <span className="bg-white border border-slate-100 px-3 py-1 rounded-lg shadow-sm">{filtered.filter(i => i.status === s).length}</span>
                                </h3>
                                <div className={`flex-1 rounded-[2.5rem] p-4 border-2 border-dashed flex flex-col gap-5 ${s === 'Aguardando Correção' ? 'bg-purple-50/50 border-purple-200' : 'bg-slate-100/40 border-slate-200/50'}`}>
                                    {filtered.filter(i => i.status === s).map(inq => {
                                        const d = getDays(inq.lastRenewal);
                                        const urgency = d <= 10 ? 'red' : d <= 20 ? 'amber' : 'emerald';
                                        return (
                                            <div key={inq.id} onClick={() => { setEditingInquerito(inq); setIsModalOpen(true); }} className="bg-white rounded-[2rem] p-7 shadow-sm border border-slate-200 hover:shadow-2xl hover:border-indigo-400 transition-all cursor-pointer relative overflow-hidden group">
                                                <div className={`absolute top-0 left-0 w-full h-2 bg-${urgency}-500 ${d <= 10 ? 'animate-pulse' : ''}`}></div>
                                                <div className="flex justify-between items-start mb-5">
                                                    <span className="text-[12px] font-mono font-black text-slate-700 bg-slate-100 px-4 py-2 rounded-2xl border border-slate-200 shadow-inner">{inq.numero}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); if(confirm('Excluir?')) deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inqueritos', inq.id)); }} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-all p-2 hover:bg-red-50 rounded-xl"><Icon name="Trash2" className="w-5 h-5" /></button>
                                                </div>
                                                {inq.responsavel && (
                                                    <div className="mb-4 flex items-center gap-2">
                                                        <span className="bg-indigo-50 text-indigo-700 border border-indigo-100 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider flex items-center gap-1">
                                                            <Icon name="User" className="w-3 h-3" /> {inq.responsavel}
                                                        </span>
                                                    </div>
                                                )}
                                                <div className={`text-[11px] font-black uppercase tracking-widest px-4 py-2.5 rounded-2xl border mb-4 flex items-center gap-3 ${urgency === 'red' ? 'bg-red-50 text-red-600 border-red-100' : urgency === 'amber' ? 'bg-amber-50 text-amber-600 border-amber-100' : 'bg-emerald-50 text-emerald-600 border-emerald-100'}`}>
                                                    <Icon name={urgency === 'red' ? 'AlertTriangle' : urgency === 'amber' ? 'Clock' : 'CheckCircle'} className="w-4 h-4" /> {d} DIAS RESTANTES
                                                </div>
                                                {inq.observacoes && <p className="text-[12px] text-slate-500 italic line-clamp-4 mb-5 bg-slate-50/50 p-4 rounded-2xl border border-slate-100/50">"{inq.observacoes}"</p>}
                                                <div className="flex justify-between items-center pt-5 border-t border-slate-50">
                                                    <span className="text-[10px] font-bold text-slate-400 uppercase flex items-center gap-2 tracking-tighter"><Icon name="Calendar" className="w-4 h-4 opacity-40" /> {new Date(inq.lastRenewal).toLocaleDateString('pt-BR')}</span>
                                                    <button onClick={(e) => { e.stopPropagation(); updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inqueritos', inq.id), { lastRenewal: new Date().toISOString(), updatedAt: new Date().toISOString() }); notify("Prazo renovado!"); }} className="text-[10px] font-black text-indigo-600 bg-indigo-50 px-4 py-2 rounded-xl hover:bg-indigo-600 hover:text-white transition-all uppercase shadow-sm">RENOVAR</button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 backdrop-blur-[6px] p-6" onClick={() => setIsModalOpen(false)}>
                            <div className="bg-white rounded-[4rem] w-full max-w-2xl overflow-hidden shadow-2xl animate-in zoom-in duration-300 border border-white/20" onClick={e => e.stopPropagation()}>
                                <div className="px-14 py-10 bg-slate-50 border-b flex justify-between items-center">
                                    <div><h2 className="text-2xl font-black uppercase text-slate-9
