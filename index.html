<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão - 3ª Promotoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        // CONFIGURAÇÃO DO FIREBASE
       window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyAzad4DmO5ZyKBgMSpjsivd6c0_VJ6LwvY",
            authDomain: "painel-promotoria.firebaseapp.com",
            projectId: "painel-promotoria",
            storageBucket: "painel-promotoria.firebasestorage.app",
            messagingSenderId: "357692683201",
            appId: "1:357692683201:web:09021bd141cc33e2aeb540",
            measurementId: "G-36RC8TJSRC"
        });

        // MANTENDO O ID ORIGINAL PARA NÃO PERDER SEUS DADOS ANTIGOS
        window.__app_id = 'promotoria-gestao-v1'; 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .kanban-column { min-width: 350px; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-[#f8fafc]">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { useState, useEffect, useRef } = React;

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'promotoria-gestao-default';

        // Inicialização Firebase
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erro Firebase:", error);
        }

        const AREAS = [
            { id: 'meio-ambiente', label: 'Meio Ambiente', icon: 'ShieldCheck' },
            { id: 'execucao-penal', label: 'Execução Penal', icon: 'Gavel' },
            { id: 'urbanismo', label: 'Urbanismo', icon: 'MapPin' },
            { id: 'delegacao', label: 'Delegação', icon: 'UserCheck' },
        ];

        // NOVA ORDEM DE STATUS COM A COLUNA DE CORREÇÃO
        const STATUS_OPTIONS = [
            'Cota de diligência', 
            'Manifestação', 
            'Aguardando Correção', // Nova Coluna Adicionada
            'Encaminhado para fazer denúncia',
            'Denunciado', 
            'Encaminhado para fazer arquivamento', 
            'Arquivado',
            'Encaminhado para ANPP', 
            'Oferecido ANPP', 
            'Finalizado'
        ];

        const RENEWAL_DAYS = 90;

        const Icon = ({ name, className }) => {
            useEffect(() => { if(window.lucide) lucide.createIcons(); }, [name]);
            return <i data-lucide={name.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2')} className={className}></i>;
        };

        // --- COMPONENTE DE LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    setError(err.message.includes('auth/invalid-credential') ? 'Dados incorretos.' : err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="bg-white p-10 rounded-[2.5rem] shadow-2xl max-w-md w-full border border-slate-200">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <Icon name="Lock" className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-black text-slate-800 uppercase tracking-tighter">Acesso Restrito</h1>
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mt-2">Painel de Gestão</p>
                        </div>
                        <form onSubmit={handleAuth} className="flex flex-col gap-4">
                            <input type="email" placeholder="E-mail Institucional" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm font-bold" required />
                            <input type="password" placeholder="Senha" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm font-bold" required />
                            {error && <div className="text-red-500 text-xs font-bold bg-red-50 p-3 rounded-xl text-center">{error}</div>}
                            <button type="submit" className="bg-slate-900 text-white py-4 rounded-2xl font-black uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg mt-2">
                                {isRegistering ? 'Cadastrar Acesso' : 'Entrar no Sistema'}
                            </button>
                        </form>
                        <button onClick={() => setIsRegistering(!isRegistering)} className="w-full text-center mt-6 text-xs font-bold text-slate-400 hover:text-indigo-600 uppercase tracking-wider">
                            {isRegistering ? 'Voltar para Login' : 'Primeiro acesso? Clique aqui'}
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [isAuthorized, setIsAuthorized] = useState(false);
            const [inqueritos, setInqueritos] = useState([]);
            const [authorizedUsers, setAuthorizedUsers] = useState([]); // Lista de emails permitidos
            
            const [activeArea, setActiveArea] = useState('meio-ambiente');
            const [searchTerm, setSearchTerm] = useState('');
            
            // Modais
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isUploadModalOpen, setIsUploadModalOpen] = useState(false);
            const [isTeamModalOpen, setIsTeamModalOpen] = useState(false);
            
            const [editingInquerito, setEditingInquerito] = useState(null);
            const [loading, setLoading] = useState(true);
            const [notification, setNotification] = useState(null);

            // --- AUTENTICAÇÃO E PERMISSÕES ---
            useEffect(() => {
                if (!auth) return;
                return onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        setUser(u);
                        // Verificar permissões
                        const usersRef = collection(db, 'artifacts', appId, 'config', 'users', 'list');
                        
                        // Escutar lista de usuários permitidos em tempo real
                        const unsubscribe = onSnapshot(usersRef, async (snapshot) => {
                            const allowedList = snapshot.docs.map(d => d.data().email);
                            setAuthorizedUsers(allowedList);
                            
                            // Lógica de "Bootstrap": Se a lista estiver vazia, o primeiro user vira admin
                            if (allowedList.length === 0) {
                                await addDoc(usersRef, { email: u.email, role: 'admin', addedAt: new Date().toISOString() });
                                setIsAuthorized(true);
                                notify("Primeiro usuário configurado como Admin!");
                            } else {
                                if (allowedList.includes(u.email)) {
                                    setIsAuthorized(true);
                                } else {
                                    setIsAuthorized(false);
                                    notify("Acesso não autorizado. Contate o administrador.");
                                    setTimeout(() => signOut(auth), 3000);
                                }
                            }
                            setLoading(false);
                        });
                        return () => unsubscribe();
                    } else {
                        setUser(null);
                        setIsAuthorized(false);
                        setLoading(false);
                    }
                });
            }, []);

            // --- CARREGAR DADOS ---
            useEffect(() => {
                if (!user || !isAuthorized) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos');
                return onSnapshot(q, (s) => setInqueritos(s.docs.map(d => ({ id: d.id, ...d.data() }))));
            }, [user, isAuthorized]);

            const notify = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };

            // --- SALVAR REGISTRO ---
            const handleSave = async (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                const dManual = f.get('date');
                const date = dManual ? new Date(dManual + "T12:00:00Z").toISOString() : new Date().toISOString();
                
                const data = {
                    numero: f.get('numero'),
                    area: f.get('area'),
                    status: f.get('status'),
                    observacoes: f.get('obs'),
                    responsavel: f.get('responsavel'),
                    lastRenewal: date,
                    updatedAt: new Date().toISOString(),
                    updatedBy: user.email
                };

                try {
                    if (editingInquerito) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inqueritos', editingInquerito.id), data);
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos'), data);
                    }
                    setIsModalOpen(false); setEditingInquerito(null); notify("Registro guardado!");
                } catch (err) { notify("Erro ao salvar: " + err.message); }
            };

            // --- IMPORTAR CSV (ARRASTAR ARQUIVO) ---
            const handleFileUpload = async (e) => {
                e.preventDefault();
                const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    const text = event.target.result;
                    const rows = text.split('\n');
                    const batch = writeBatch(db);
                    let count = 0;

                    // Formato esperado CSV: numero;status;obs
                    rows.forEach(row => {
                        const cols = row.split(';'); // Usa ponto e vírgula que é comum no Excel BR
                        if (cols.length >= 2) {
                            const numero = cols[0].trim();
                            const status = cols[1].trim();
                            const obs = cols[2] ? cols[2].trim() : '';
                            
                            // Validação simples
                            if(numero && STATUS_OPTIONS.includes(status)) {
                                const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inqueritos'));
                                batch.set(ref, {
                                    numero,
                                    area: 'meio-ambiente', // Padrão, pode melhorar depois
                                    status,
                                    observacoes: obs,
                                    responsavel: '',
                                    lastRenewal: new Date().toISOString(),
                                    updatedAt: new Date().toISOString(),
